(function(a,b,c){var d=a(c),e=a(b),f={color:"000000",onChange:function(){},onHide:function(){},onLive:function(){},onShow:function(){},onSubmit:function(){}},g={4:{field:"r",max:255,model:"rgb"},5:{field:"g",max:255,model:"rgb"},6:{field:"b",max:255,model:"rgb"},7:{field:"h",max:360,model:"hsv"},8:{field:"s",max:100,model:"hsv"},9:{field:"v",max:100,model:"hsv"}},h='<div class="palette"><div class="palette_selector"><div><div>&nbsp;</div></div></div><div class="palette_hue"><div class="palette_hue_slider">&nbsp;</div><div>&nbsp;</div></div><div class="palette_new_color"><div>&nbsp;</div></div><div class="palette_current_color"><div>&nbsp;</div></div><div class="palette_field palette_r"><input type="text" maxlength="3"><span>&nbsp;</span></div><div class="palette_field palette_g"><input type="text" maxlength="3"><span>&nbsp;</span></div><div class="palette_field palette_b"><input type="text" maxlength="3"><span>&nbsp;</span></div><div class="palette_field palette_h"><input type="text" maxlength="3"><span>&nbsp;</span></div><div class="palette_field palette_s"><input type="text" maxlength="3"><span>&nbsp;</span></div><div class="palette_field palette_v"><input type="text" maxlength="3"><span>&nbsp;</span></div><div class="palette_hex"><input type="text" maxlength="6"></div><div class="palette_submit">&nbsp;</div></div>',i=function(b){var c=b.data("palette");b.find(".palette_selector > div").mousedown(function(e){if(!(e.which>1||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){e.preventDefault();var f=a(this);k(f,e.pageX,e.pageY),d.on("mousemove.palette",function(a){k(f,a.pageX,a.pageY)}).one("mouseup.palette",function(){d.off("mousemove.palette"),c.onChange(b)})}}),b.children(".palette_hue").mousedown(function(e){if(!(e.which>1||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){e.preventDefault();var f=a(this);j(f,e.pageY),d.on("mousemove.palette",function(a){j(f,a.pageY)}).one("mouseup.palette",function(){d.off("mousemove.palette"),c.onChange(b)})}}),b.children(".palette_current_color").click(function(d){d.which>1||d.altKey||d.ctrlKey||d.metaKey||d.shiftKey||a.palette.color(b,c.current.hsv,"current")}),b.find(".palette_field input").keyup(function(d){var e=a(this),f=parseInt(e.val(),10);if(d.which==13||d.which==27)e.blur();else{var h=g[e.parent().index()],i=a.extend({},c.color[h.model]);isNaN(f)?f=0:f>h.max&&(e.val(h.max.toString()),f=h.max),i[h.field]=f,a.palette.color(b,i,h.field)}}).keydown(function(d){if(d.which==38||d.which==40){var e=a(this),f=g[e.parent().index()],h=val=parseInt(e.val(),10),i=a.extend({},c.color[f.model]);isNaN(val)&&(h=val=0),d.which==40&&val>0?(val--,e.val(val.toString())):d.which==38&&val<f.max&&(val++,e.val(val.toString())),val!=h&&(i[f.field]=val,a.palette.color(b,i,f.field))}}).blur(function(){var b=a(this),c=parseInt(b.val(),10);isNaN(c)?b.val("0"):c.toString()!=b.val()&&b.val(c.toString())}),b.find(".palette_field span").mousedown(function(e){if(!(e.which>1||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){e.preventDefault();var f=a(this),h=f.parent(),i=h.children("input"),j=g[h.index()],k=parseInt(i.val(),10),l=e.pageY;d.on("mousemove.palette",function(d){var e=a.extend({},c.color[j.model]),f=Math.min(Math.max(k+l-d.pageY,0),j.max);i.val(f),e[j.field]=f,a.palette.color(b,e,"slider")}).one("mouseup.palette",function(){d.off("mousemove.palette"),c.onChange(b)})}}),b.find(".palette_hex input").keyup(function(c){var d=a(this);c.which==13||c.which==27?d.blur():(d.val().length==3||d.val().length==6)&&a.palette.color(b,d.val(),"hex")}).blur(function(){a.palette.color(b,c.color.hsv,"blur")}),b.children(".palette_submit").click(function(d){d.which>1||d.altKey||d.ctrlKey||d.metaKey||d.shiftKey||(b.find(".palette_current_color div").css("background-color","#"+a.palette.color(b)),c.current=a.extend({},c.color),c.onSubmit(b))})},j=function(b,c){var d=b.closest(".palette"),b=b.children("div:last"),e=b.offset(),f=c<e.top?0:c>e.top+150?150:c-e.top;b.prev().css("top",f.toString()+"px"),a.palette.color(d,a.extend({},d.data("palette").color.hsv,{h:360*(150-Math.max(0,Math.min(150,f)))/150}),"hue")},k=function(b,c,d){var e=b.closest(".palette"),f=b.offset(),g=d<f.top?0:d>f.top+150?150:d-f.top,h=c<f.left?0:c>f.left+150?150:c-f.left;b.children("div").css({top:g.toString()+"px",left:h.toString()+"px"}),a.palette.color(e,a.extend({},e.data("palette").color.hsv,{s:100*Math.max(0,Math.min(150,h))/150,v:100*(150-Math.max(0,Math.min(150,g)))/150}),"selector")},l=function(a,b){for(field in a)if(a[field]!=b[field])return!1;return!0},m=function(a){var b=a.data("palette").parent,c=b.outerHeight(),d=b.offset(),f=b.outerWidth();e.height()-(d.top-e.scrollTop()+c)>182?a.css("top",(d.top+c).toString()+"px"):a.css("top",(d.top-182).toString()+"px"),e.width()-d.left-e.scrollLeft()>367?a.css("left",d.left.toString()+"px"):a.css("left",(d.left-f-367).toString()+"px")};a.palette={color:function(b,c,d){if(typeof c=="undefined")return b.find(".palette_hex input").val();var c=parse_color(c),e=b.data("palette"),f=a.extend({},e.color),g=c.hex,h=c.hsv,i=c.rgb,j=parse_color({h:h.h,s:100,v:100});e.color=c,d!="selector"&&(b.find(".palette_selector > div").css("background-color","#"+j.hex),b.find(".palette_selector div div").css({top:(150*(100-h.v)/100).toString()+"px",left:(150*h.s/100).toString()+"px"})),d!="hue"&&b.find(".palette_hue_slider").css("top",(150-150*h.h/360).toString()+"px"),b.find(".palette_new_color div").css("background-color","#"+g),typeof d=="undefined"&&(b.find(".palette_current_color div").css("background-color","#"+g),e.current=c,e.onSubmit(b));for(field in i)d!=field&&b.find(".palette_"+field+" input").val(i[field]);for(field in h)d!=field&&b.find(".palette_"+field+" input").val(Math.round(h[field]));d!="hex"&&b.find(".palette_hex input").val(g);if(!f.hsv||!l(h,f.hsv))d=="selector"||d=="hue"||d=="slider"?e.onLive(b):e.onChange(b)},hide:function(){a(".palette:visible").each(function(){var b=a(this);b.find("input:focus").blur(),b.fadeOut(500,function(){b.data("palette").onHide(b)})})},show:function(a){m(a,a.data("palette").parent),a.fadeIn(500,function(){a.data("palette").onShow(a)})}},d.on("keyup.palette",function(b){b.which==27&&a.palette.hide()}),a.fn.palette=function(b){b=a.extend({},f,b||{});var d=this,e=a(c.body);return d.each(function(){var c=a(this);if(!c.data("palette")){var d=a(h);e.append(d),d.data("palette",a.extend({},b,{parent:c})),c.data("palette",{palette:d}),i(d),a.palette.color(d,b.color),m(d),c.on("click.palette",function(b){!(b.which>1||b.altKey||b.ctrlKey||b.metaKey||b.shiftKey)&&b.target==this&&(a.palette.hide(),d.is(":visible")||a.palette.show(d))})}})}})(jQuery,window,document)
